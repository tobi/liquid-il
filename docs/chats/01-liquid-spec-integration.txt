
 * ▐▛███▜▌ *   Claude Code v2.0.76
* ▝▜█████▛▘ *  Opus 4.5 · API Usage Billing
 *  ▘▘ ▝▝  *   ~/src/tries/2026-01-05-liquid-il

  Welcome to Opus 4.5

> {%- render 'snippets/foo' depth: depth -%}
RUBY
Source locally installed gems is ignoring #<Bundler::StubSpecification 
name=strscan version=3.1.6 platform=ruby> because it is missing extensions
Source locally installed gems is ignoring #<Bundler::StubSpecification 
name=strscan version=3.1.7 platform=ruby> because it is missing extensions
Source locally installed gems is ignoring #<Bundler::StubSpecification 
name=prism version=1.7.0 platform=ruby> because it is missing extensions
Source locally installed gems is ignoring #<Bundler::StubSpecification 
name=liquid-c version=4.2.0 platform=ruby> because it is missing extensions
Source locally installed gems is ignoring #<Bundler::StubSpecification 
name=json version=2.18.0 platform=ruby> because it is missing extensions
bundler: failed to load command: liquid-spec (/Users/tobi/.local/share/mise/
installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bin/liquid-spec)
/Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundle
r/gems/liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb:445:in 
'Liquid::Spec::CLI::Eval.load_spec_from_string': no implicit conversion of 
String into Integer (TypeError)

            options[:liquid] = spec["template"] || spec[:template]
                                    ^^^^^^^^^^
        from 
/Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundle
r/gems/liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb:118:in 
'Liquid::Spec::CLI::Eval.run_eval'
        from 
/Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundle
r/gems/liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb:79:in 
'Liquid::Spec::CLI::Eval.run'
        from /Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems
/4.0.0/bundler/gems/liquid-spec-dfb00bbed75d/lib/liquid/spec/cli.rb:107:in 
'Liquid::Spec::CLI.run'
        from /Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems
/4.0.0/bundler/gems/liquid-spec-dfb00bbed75d/bin/liquid-spec:7:in '<top 
(required)>'
        from /Users/tobi/.local/share/mise/installs/ruby/4.0.0/lib/ruby/4.0.
0/rubygems.rb:303:in 'Kernel#load'
        from /Users/tobi/.local/share/mise/instal 

⏺ Looking at this error, it seems the liquid-spec eval command is getting a String back when it expects a Hash with a "template" key. Let me check the adapter to understand what's happening:

⏺ Read(adapter.rb)
  ⎿  Read 53 lines

⏺ The error is coming from liquid-spec's eval.rb, not your LiquidIL code. The error message shows:

  options[:liquid] = spec["template"] || spec[:template]
                          ^^^^^^^^^^

  This indicates liquid-spec is receiving a String when it expects a Hash.

  Looking at your input, it seems like you're passing a multiline template with RUBY at the end (possibly a heredoc that wasn't properly formatted). What command are you running exactly?

  If you're trying to eval a render tag template, you'd use something like:

  bundle exec liquid-spec eval adapter.rb -l "{% render 'foo' %}"

  However, render tags also need a file system with the snippet available. For the eval command, you might need to use a spec file (YAML) that defines both the template and the partials, rather than the -l flag.

  Could you share the exact command you ran? The RUBY in your output suggests there may have been an issue with how the template string was passed.

> then we aren't YAML.loading the heredoc parameter 

⏺ Ah, so when passing a YAML spec via heredoc to -l, it's not being parsed as YAML. Let me check how liquid-spec handles the -l parameter:

⏺ Read(~/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundler/gems/
      liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb)
  ⎿ Tool use rejected with user message: no -l parameter, the string that's 
    passed is a yaml

⏺ Got it - so when passing a YAML spec string directly, it's not being YAML.load'd before trying to access spec["template"]. Let me check the eval.rb code:

⏺ Read(~/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundler/gems/
      liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb)
  ⎿  Read 536 lines

⏺ Found it! The issue is in load_spec_from_string at line 440-454. The YAML is being loaded, but YAML.safe_load returns a String when the input is just a plain template string (like {%- render ... -%}), not a Hash with keys.

  When you pass:
  {%- render 'snippets/foo' depth: depth -%}

  YAML parses that as a plain string, not a hash. Then spec["template"] fails because you can't index a String with a String key.

  The fix should be to detect when the YAML parsed result is a String and treat it as the template directly:

  def load_spec_from_string(yaml_content, options)
    require "yaml"

    spec = YAML.safe_load(yaml_content, permitted_classes: [Symbol])

    # Handle plain template string (not a YAML hash)
    if spec.is_a?(String)
      spec = { "template" => spec }
    end

    options[:liquid] = spec["template"] || spec[:template]
    # ... rest of method

  Or alternatively, the -l flag behavior could be restored for simple one-liner templates. Want me to check if there's a -l option that was removed, or should the fix be to make load_spec_from_string handle String results?

> use the same loader function 

⏺ Update(~/.local/share/mise/installs/ruby/4.0.0/lib/ruby/gems/4.0.0/bundler/gem
        s/liquid-spec-dfb00bbed75d/lib/liquid/spec/cli/eval.rb)
  ⎿  Added 3 lines                                                       
      442                                                                
      443              spec = YAML.safe_load(yaml_content,               
           permitted_classes: [Symbol])                                  
      444                                                                
      445 +            # Handle plain template string (not a YAML hash)  
      446 +            spec = { "template" => spec } if                  
          +spec.is_a?(String)                                            
      447 +                                                              
      448              options[:liquid] = spec["template"] ||            
           spec[:template]                                               
      449              options[:expected] = spec["expected"] ||          
           spec[:expected] if spec.key?("expected") ||                   
           spec.key?(:expected)                                          
      450              options[:assigns] = spec["environment"] ||        
           spec[:environment] || spec["assigns"] || spec[:assigns] || {} 

⏺ Done. Now when you pipe a plain template string, it'll be wrapped as { "template" => spec } so the rest of the loader works correctly.



